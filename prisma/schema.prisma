generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model User {
  id        String          @id @default(cuid())
  email     String          @unique
  name      String?
  plan      String          @default("TENTANDO_A_SORTE") // ou "RUMO_A_APROVACAO"
  groups    QuestionGroup[]
  essays    Essay[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
}

model Exam {
  id        String     @id @default(cuid())
  year      Int        @unique
  questions Question[]
}

model Question {
  id                  String              @id @default(cuid())
  examId              String
  exam                Exam                @relation(fields: [examId], references: [id])
  questionNumber      Int
  knowledgeArea       String // LINGUAGENS, CIENCIAS_HUMANAS, CIENCIAS_NATUREZA, MATEMATICA
  subject             String // PORTUGUES, MATEMATICA, HISTORIA, etc.
  statement           String
  context             String?
  optionA             String
  optionB             String
  optionC             String
  optionD             String
  optionE             String
  correctAnswer       String
  imageUrl            String?
  supportingMaterials String? // JSON array of text/image blocks
  languageOption      String? // INGLES or ESPANHOL for Q1-5
  aiExplanation       String?
  groups              QuestionsOnGroups[]

  @@unique([examId, questionNumber])
  @@index([knowledgeArea])
  @@index([subject])
  @@index([examId])
}

model QuestionGroup {
  id           String              @id @default(cuid())
  userId       String
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  name         String
  description  String?
  color        String              @default("#6366f1")
  savedFilters String? // JSON com filtros salvos
  questions    QuestionsOnGroups[]
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@index([userId])
}

model QuestionsOnGroups {
  questionId String
  question   Question      @relation(fields: [questionId], references: [id], onDelete: Cascade)
  groupId    String
  group      QuestionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  addedAt    DateTime      @default(now())

  @@id([questionId, groupId])
  @@index([groupId])
  @@index([questionId])
}

model Essay {
  id         String           @id @default(cuid())
  userId     String
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  title      String?
  theme      String?
  content    String
  wordCount  Int              @default(0)
  status     String           @default("DRAFT") // DRAFT, SUBMITTED, CORRECTED
  correction EssayCorrection?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@index([userId])
  @@index([status])
}

model EssayCorrection {
  id      String @id @default(cuid())
  essayId String @unique
  essay   Essay  @relation(fields: [essayId], references: [id], onDelete: Cascade)

  // Competence scores (0-200 each)
  competence1Score    Int
  competence1Feedback String
  competence2Score    Int
  competence2Feedback String
  competence3Score    Int
  competence3Feedback String
  competence4Score    Int
  competence4Feedback String
  competence5Score    Int
  competence5Feedback String

  // Total score (0-1000)
  totalScore      Int
  generalFeedback String

  createdAt DateTime @default(now())

  @@index([essayId])
}
